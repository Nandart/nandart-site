<!DOCTYPE html>
<html lang="pt">
  <head>
    <meta charset="UTF-8" />
    <title>Painel de Aprovação - NANdART</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      body {
        font-family: 'Segoe UI', sans-serif;
        background-color: #121212;
        color: #f5f5f5;
        margin: 0;
        padding: 2rem;
      }

      h1 {
        text-align: center;
        color: #f3c677;
      }

      .obra {
        border: 1px solid #444;
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 1.5rem;
        background-color: #1e1e1e;
      }

      .obra img {
        max-width: 100%;
        border-radius: 6px;
        margin-top: 1rem;
      }

      button {
        background-color: #f3c677;
        color: #000;
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
        margin-top: 1rem;
      }

      button:disabled {
        background-color: #777;
        cursor: not-allowed;
      }

      .mensagem {
        margin-top: 1rem;
        font-style: italic;
      }
    </style>
  </head>
  <body>
    <h1>Painel de Aprovação de Obras</h1>
    <div id="painel"></div>

    <script>
      const token = new URLSearchParams(window.location.search).get('token');
      if (token !== 'fernanda2025visao') {
        document.body.innerHTML = '<h2>Acesso não autorizado</h2>';
        throw new Error('Acesso negado');
      }

      async function carregarSubmissoes() {
        const resp = await fetch('/api/submissoes');
        const { obras } = await resp.json();
        const painel = document.getElementById('painel');
        painel.innerHTML = '';

        obras.forEach((obra) => {
          const div = document.createElement('div');
          div.className = 'obra';

          const obrigatorios = ['titulo', 'artista', 'ano', 'descricao', 'local', 'imagem'];
          const emFalta = obrigatorios.filter((campo) => !obra[campo]);

          div.innerHTML = `
            <h3>${obra.titulo || 'Sem Título'}</h3>
            <p><strong>Artista:</strong> ${obra.artista || '—'}</p>
            <p><strong>Estilo:</strong> ${obra.estilo || '—'}</p>
            <p><strong>Técnica:</strong> ${obra.tecnica || '—'}</p>
            <p><strong>Ano:</strong> ${obra.ano || '—'}</p>
            <p><strong>Dimensões:</strong> ${obra.dimensoes || '—'}</p>
            <p><strong>Materiais:</strong> ${obra.materiais || '—'}</p>
            <p><strong>Local:</strong> ${obra.local || '—'}</p>
            <p><strong>Descrição:</strong> ${obra.descricao || '—'}</p>
            ${obra.imagem ? `<img src="${obra.imagem}" alt="Imagem da obra" />` : ''}
            <button onclick="aprovar(this, ${obra.numero})" ${emFalta.length ? 'disabled' : ''}>
              Aprovar Obra
            </button>
            <div class="mensagem"></div>
          `;
          painel.appendChild(div);
        });
      }

      async function aprovar(botao, numero) {
        botao.disabled = true;
        botao.textContent = 'Aprovar...';
        const mensagem = botao.nextElementSibling;

        const obraDiv = botao.parentElement;
        const campos = ['Artista', 'Título', 'Estilo', 'Técnica', 'Ano', 'Dimensões', 'Materiais', 'Local', 'Descrição'];
        const dados = {};

        campos.forEach((campo) => {
          const p = Array.from(obraDiv.querySelectorAll('p')).find((p) => p.textContent.startsWith(campo));
          dados[campo.toLowerCase()] = p ? p.textContent.split(':').slice(1).join(':').trim() : '';
        });

        const imagem = obraDiv.querySelector('img')?.src || '';

        const payload = {
          numero,
          artista: dados['artista'],
          titulo: dados['título'],
          estilo: dados['estilo'],
          tecnica: dados['técnica'],
          ano: dados['ano'],
          dimensoes: dados['dimensões'],
          materiais: dados['materiais'],
          local: dados['local'],
          descricao: dados['descrição'],
          imagem,
        };

        try {
          const resp = await fetch('/api/aprovar', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });

          const res = await resp.json();
          if (res.sucesso) {
            mensagem.textContent = '✅ Obra aprovada com sucesso!';
            obraDiv.style.opacity = 0.5;
          } else {
            mensagem.textContent = '❌ Erro: ' + res.mensagem;
            botao.disabled = false;
            botao.textContent = 'Aprovar Obra';
          }
        } catch (e) {
          mensagem.textContent = '❌ Erro ao enviar a aprovação.';
          botao.disabled = false;
          botao.textContent = 'Aprovar Obra';
        }
      }

      carregarSubmissoes();
    </script>
  </body>
</html>
